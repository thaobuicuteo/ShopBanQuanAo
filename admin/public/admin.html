<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRANG QU·∫¢N TR·ªä</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tabler-ui@1.0.0-alpha.41/dist/css/tabler.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f4f4f4;
    }

    header {
      background-color: #F0EDE6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
    }

    .logo-img {
      border-radius: 50%;
      width: 75px;
      height: 75px;
      object-fit: cover;
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 28px;
      color: #333;
      margin-left: -75px;
    }

    .admin-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #555;
      position: relative;
    }

    .card {
      margin-bottom: 2rem;
    }

    .table th,
    .table td {
      vertical-align: middle !important;
    }

    .search-input {
      width: 200px;
      float: right;
      margin-bottom: 1rem;
    }

    @media (max-width: 500px) {
      .header-title {
        font-size: 20px;
        margin-left: 0;
      }

      .admin-info {
        gap: 6px;
      }
    }

    #message-icon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      cursor: pointer;
      z-index: 1000;
    }

    #message-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .dropdown-logout {
      position: relative;
      display: inline-block;
    }

    .logout-menu {
      position: absolute;
      top: 36px;
      right: 0;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 999;
      min-width: 120px;
    }

    .logout-menu a {
      display: block;
      padding: 8px 12px;
      text-decoration: none;
      color: #333;
      transition: background-color 0.2s;
    }

    .logout-menu a:hover {
      background-color: #f0f0f0;
    }

    .admin-info button {
      background-color: transparent;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      position: relative;
      padding: 0;
    }

    .admin-info img {
      width: 24px;
      height: 24px;
    }

    #revenueChart {
      height: 300px !important;
    }

    .address-details {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <header>
    <img src="image/logo.jpg" alt="Logo" class="logo-img">
    <h1 class="header-title">TRANG QU·∫¢N TR·ªä</h1>
    <div class="admin-info">
      <div><span class="name"></span></div>
      <!-- Icon tin nh·∫Øn
      <div id="message-icon">
        <img id="message-img" src="image/mess1.png" alt="Tin nh·∫Øn">
      </div> -->
      <!-- Dropdown Logout -->
      <div class="dropdown-logout">
        <button id="logout-btn" title="T√†i kho·∫£n">
          <img src="image/login.png" alt="Menu t√†i kho·∫£n">
        </button>
        <div id="logout-menu" class="logout-menu">
          <a href="login.html">üîí ƒêƒÉng xu·∫•t</a>
        </div>
      </div>
    </div>
  </header>
  <!-- Thay th·∫ø ph·∫ßn Th·ªëng k√™ doanh thu -->
  <div class="card m-3">
    <div class="card-header">üìä Th·ªëng k√™ doanh thu</div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-3">
        <select id="timeFilter" class="form-select w-auto">
          <option value="day">Theo ng√†y</option>
          <option value="month">Theo th√°ng</option>
        </select>
        <select id="paymentFilter" class="form-select w-auto">
          <option value="">T·∫•t c·∫£</option>
          <option value="0">Ti·ªÅn m·∫∑t</option>
          <option value="1">Ng√¢n h√†ng</option>
        </select>
        <button class="btn btn-primary" onclick="updateRevenueChart()">C·∫≠p nh·∫≠t</button>
      </div>
      <canvas id="revenueChart"></canvas>
      <p id="totalStats">üìà T·ªïng doanh thu: 0 VNƒê</p>
    </div>
  </div>
  <!-- Tabs qu·∫£n l√Ω -->
  <ul class="nav nav-tabs px-3" id="adminTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#usersTab">üë§ Ng∆∞·ªùi d√πng</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#productsTab">üì¶ S·∫£n ph·∫©m</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ordersTab">üßæ ƒê∆°n h√†ng</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#collectionsTab">üé® B·ªô s∆∞u t·∫≠p</a></li>
  </ul>
  <div class="tab-content pt-4 px-3">
    <!-- Tab Ng∆∞·ªùi d√πng -->
    <div class="tab-pane fade show active" id="usersTab">
      <div class="d-flex justify-content-between mb-3">
        <input class="form-control search-input" placeholder="T√¨m ng∆∞·ªùi d√πng..."
          oninput="searchTable('users', this.value)">
        <!-- <button class="btn btn-primary" onclick="openForm('users')">‚ûï Th√™m ng∆∞·ªùi d√πng</button> -->
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="usersTable">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Thao t√°c</th>
              <th>Chi ti·∫øt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Tab S·∫£n ph·∫©m -->
    <div class="tab-pane fade" id="productsTab">
      <div class="d-flex justify-content-between mb-3">
        <input class="form-control search-input" placeholder="üîç T√¨m s·∫£n ph·∫©m..."
          oninput="searchTable('products', this.value)">
        <button class="btn btn-primary" onclick="openForm('products')">‚ûï Th√™m s·∫£n ph·∫©m</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="productsTable">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>T√™n</th>
              <th>Gi√°</th>
              <th>·∫¢nh</th>
              <th>Gi√° KM</th>
              <th>Chi ti·∫øt</th>
              <th>ID BST</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Tab ƒê∆°n h√†ng -->
    <div class="tab-pane fade" id="ordersTab">
      <div class="d-flex justify-content-between mb-3">
        <input class="form-control search-input" placeholder="üîç T√¨m ƒë∆°n h√†ng..."
          oninput="searchTable('orders', this.value)">
        <!-- <button class="btn btn-primary" onclick="openForm('orders')">‚ûï Th√™m ƒë∆°n h√†ng</button> -->
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="ordersTable">
          <thead class="table-dark">
            <tr>
              <th>Order ID</th>
              <th>User ID</th>
              <th>T·ªïng ti·ªÅn</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y</th>
              <th>Thao t√°c</th>
              <th>Chi ti·∫øt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Tab B·ªô s∆∞u t·∫≠p -->
    <div class="tab-pane fade" id="collectionsTab">
      <div class="d-flex justify-content-between mb-3">
        <input class="form-control search-input" placeholder="üîç T√¨m b·ªô s∆∞u t·∫≠p..."
          oninput="searchTable('collections', this.value)">
        <button class="btn btn-primary" onclick="openForm('collections')">‚ûï Th√™m b·ªô s∆∞u t·∫≠p</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="collectionsTable">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>T√™n</th>
              <th>NƒÉm</th>
              <th>·∫¢nh</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Modal Form -->
    <div class="modal fade" id="formModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="formContent">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Th√™m d·ªØ li·ªáu</h5>
            </div>
            <div class="modal-body" id="formFields"></div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">L∆∞u</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script ki·ªÉm tra tin nh·∫Øn v√† logout -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tabler-ui@1.0.0-alpha.41/dist/js/tabler.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:3000/api';
      // H√†m convert enum sang text th√¢n thi·ªán
      function getRoleText(role) {
        return role === 0 ? 'Customer' : 'Admin';
      }
      function getProductStatusText(status) {
        return status === 0 ? 'Inactive (kh√¥ng b√°n)' : 'Active (ƒëang b√°n)';
      }
      function getOrderStatusText(status) {
        const statuses = { 1: 'ƒêang x·ª≠ l√Ω', 2: 'ƒêang giao', 3: 'ƒê√£ giao', 4: 'ƒê√£ h·ªßy' };
        return statuses[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
      }
      function getPayMethodText(pay_method) {
        return Number(pay_method) === 0 ? 'Thanh to√°n ti·ªÅn m·∫∑t' : 'Thanh to√°n ng√¢n h√†ng';
      }
      function getTimeText(time) {
        if (time == 'day') {
          return 'ng√†y';
        } else if (time == 'month') {
          return 'th√°ng';
        }
      }
      // Toggle logout menu (gi·ªØ nguy√™n)
      // Load data
      window.addEventListener('load', () => {
        const username = localStorage.getItem('loggedInUser'); // Gi·∫£ ƒë·ªãnh key l√† 'loggedInUser'
        const nameSpan = document.querySelector('.name');
        if (username) {
          nameSpan.textContent = username;
        } else {
          nameSpan.textContent = 'Kh√°ch'; // M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng login
        }
      });
      // Ki·ªÉm tra v√† hi·ªÉn th·ªã username khi load trang
      window.addEventListener('load', () => {
        const username = localStorage.getItem('loggedInUser');
        const nameSpan = document.querySelector('.name');
        if (username) {
          nameSpan.textContent = `Hello, ${username}`;
          // Load d·ªØ li·ªáu ch·ªâ khi ƒë√£ login
          fetchUsers();
          fetchProducts();
          fetchOrders();
          fetchCollections();
          fetchRevenueData();
        } else {
          nameSpan.textContent = 'ƒêƒÉng nh·∫≠p';
          // Redirect v·ªÅ login n·∫øu kh√¥ng login
          window.location.href = 'login.html';
        }
      });
      // Open form
      function openForm(type, data = null) {
        const modal = new bootstrap.Modal(document.getElementById('formModal'));
        const title = document.getElementById('modalTitle');
        const fields = document.getElementById('formFields');
        const form = document.getElementById('formContent');
        title.textContent = data ? `S·ª≠a ${type}` : `Th√™m ${type}`;
        fields.innerHTML = '';
        let html = '';
        if (type === 'users') {
          html = `
        <div class="mb-3"><label>Username</label><input type="text" class="form-control" name="username" value="${data?.username || ''}" required></div>
        <div class="mb-3"><label>Password</label><input type="password" class="form-control" name="password" ${data ? '' : 'required'}></div>
        <div class="mb-3"><label>Email</label><input type="email" class="form-control" name="email" value="${data?.email || ''}"></div>
        <div class="mb-3"><label>Role (0: Customer, 1: Admin)</label><input type="number" class="form-control" name="role" value="${data?.role || 0}" min="0" max="1"></div>
      `;
        } else if (type === 'products') {
          html = `
        <div class="mb-3"><label>T√™n s·∫£n ph·∫©m</label><input type="text" class="form-control" name="product_name" value="${data?.product_name || ''}" required></div>
        <div class="mb-3"><label>Gi√°</label><input type="number" class="form-control" name="price" value="${data?.price || 0}" required></div>
        <div class="mb-3"><label>·∫¢nh URL</label><input type="text" class="form-control" name="image_url" value="${data?.image_url || ''}"></div>
        <div class="mb-3"><label>Gi√° khuy·∫øn m√£i</label><input type="number" class="form-control" name="price_promotion" value="${data?.price_promotion || 0}" required></div>
        <div class="mb-3"><label>Chi ti·∫øt</label><textarea class="form-control" name="detail">${data?.detail || ''}</textarea></div>
        <div class="mb-3"><label>ID B·ªô s∆∞u t·∫≠p</label><input type="number" class="form-control" name="collection_id" value="${data?.collection_id || ''}"></div>
        <div class="mb-3"><label>Status (0: Inactive, 1: Active)</label><input type="number" class="form-control" name="status" value="${data?.status || 1}" min="0" max="1"></div>
      `;
        } else if (type === 'orders') {
          html = `
        <div class="mb-3"><label>User ID</label><input type="number" class="form-control" name="user_id" value="${data?.user_id || ''}" required></div>
        <div class="mb-3"><label>T·ªïng ti·ªÅn</label><input type="number" class="form-control" name="total_amount" value="${data?.total_amount || 0}" required></div>
        <div class="mb-3"><label>Status (1: ƒêang x·ª≠ l√Ω, 2: ƒêang giao, 3: ƒê√£ giao, 4: ƒê√£ h·ªßy)</label><input type="number" class="form-control" name="status" value="${data?.status || 1}" min="1" max="4"></div>
      `;
        } else if (type === 'orderdetails') {
          html = `
        <div class="mb-3"><label>Order ID</label><input type="number" class="form-control" name="order_id" value="${data?.order_id || ''}" required></div>
        <div class="mb-3"><label>Product ID</label><input type="number" class="form-control" name="product_id" value="${data?.product_id || ''}" required></div>
        <div class="mb-3"><label>S·ªë l∆∞·ª£ng</label><input type="number" class="form-control" name="quantity" value="${data?.quantity || 1}" required></div>
        <div class="mb-3"><label>Gi√° ƒë∆°n v·ªã</label><input type="number" class="form-control" name="unit_price" value="${data?.unit_price || 0}" required></div>
        <div class="mb-3"><label>Ph∆∞∆°ng th·ª©c thanh to√°n (0: Ti·ªÅn m·∫∑t, 1: Ng√¢n h√†ng)</label><input type="number" class="form-control" name="pay_method" value="${data?.pay_method || 0}" min="0" max="1"></div>
      `;
        } else if (type === 'collections') {
          html = `
        <div class="mb-3"><label>T√™n b·ªô s∆∞u t·∫≠p</label><input type="text" class="form-control" name="collection_name" value="${data?.collection_name || ''}" required></div>
        <div class="mb-3"><label>NƒÉm ra m·∫Øt</label><input type="text" class="form-control" name="year_launch" value="${data?.year_launch || ''}"></div>
        <div class="mb-3"><label>·∫¢nh URL</label><input type="text" class="form-control" name="image_url" value="${data?.image_url || ''}"></div>
      `;
        }
        fields.innerHTML = html;
        form.onsubmit = (e) => handleSubmit(e, type, data?.[getIdKey(type)]);
        modal.show();
      }
      function getIdKey(type) {
        const keys = { users: 'user_id', products: 'product_id', orders: 'order_id', orderdetails: 'order_detail_id', collections: 'collection_id' };
        return keys[type];
      }
      // Handle submit (gi·ªØ nguy√™n, th√™m case cho orders/orderdetails)
      async function handleSubmit(e, type, id = null) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        console.log('Data g·ª≠i l√™n:', data); // Th√™m log ƒë·ªÉ ki·ªÉm tra
        if (type === 'orders' && !id) {
          data.order_date = new Date().toISOString(); // ƒê·∫£m b·∫£o g·ª≠i ng√†y hi·ªán t·∫°i
        }
        const endpoint = `${API_BASE}/${type === 'orderdetails' ? 'orderdetails' : type}${id ? `/${id}` : ''}`;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(endpoint, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (type === 'orders' && !id) {
          const { order_id } = await res.json();
          // C√≥ th·ªÉ m·ªü form add orderdetails ngay sau khi add order
        }
        bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
        if (type === 'users') fetchUsers();
        else if (type === 'products') fetchProducts();
        else if (type === 'orders' || type === 'orderdetails') fetchOrders();
        else if (type === 'collections') fetchCollections();
      }
      // Delete item
      async function deleteItem(type, id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?')) return;
        const endpoint = `${API_BASE}/${type}/${id}`;
        await fetch(endpoint, { method: 'DELETE' });
        if (type === 'users') fetchUsers();
        else if (type === 'products') fetchProducts();
        else if (type === 'orders' || type === 'orderdetails') fetchOrders();
        else if (type === 'collections') fetchCollections();
      }
      function formatCurrency(value) {
        return Number(value).toLocaleString('vi-VN') + ' VNƒê';
      }

      // Fetch users 
      async function fetchUsers() {
        const res = await fetch(`${API_BASE}/users`);
        const data = await res.json();
        const tbody = document.getElementById('usersTable').querySelector('tbody');
        tbody.innerHTML = data.map(u => `
    <tr>
      <td>${u.user_id}</td>
      <td>${u.username}</td>
      <td>${u.email}</td>
      <td>${getRoleText(u.role)}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='openForm("users", ${JSON.stringify(u)})'>S·ª≠a</button>
        <button class="btn btn-sm btn-danger" onclick='deleteItem("users", ${u.user_id})'>X√≥a</button>
      </td>
      <td>
        <button class="btn btn-sm btn-info" onclick="toggleAddressDetails(${u.user_id}, this)">Xem chi ti·∫øt</button>
        <div class="address-details" id="address-${u.user_id}"></div>
      </td>
    </tr>
  `).join('');
      }

      // H√†m toggleAddressDetails ƒë·ªÉ hi·ªÉn th·ªã/·∫©n chi ti·∫øt ƒë·ªãa ch·ªâ
      async function toggleAddressDetails(userId, btn) {
        const addressDiv = document.getElementById(`address-${userId}`);
        if (addressDiv.style.display === 'none' || addressDiv.style.display === '') {
          try {
            const response = await fetch(`${API_BASE}/addresses/${userId}`);
            if (response.ok) {
              const addressData = await response.json();
              addressDiv.innerHTML = `
                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${addressData.address_line || 'Ch∆∞a c√≥'}</p>
                <p><strong>Th√†nh ph·ªë:</strong> ${addressData.city || 'Ch∆∞a c√≥'}</p>
                <p><strong>Qu·∫≠n/Huy·ªán:</strong> ${addressData.district || 'Ch∆∞a c√≥'}</p>
                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${addressData.phone || 'Ch∆∞a c√≥'}</p>
              `;
              addressDiv.style.display = 'block';
              btn.textContent = '·∫®n chi ti·∫øt';
            } else {
              addressDiv.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ.</p>';
              addressDiv.style.display = 'block';
              btn.textContent = '·∫®n chi ti·∫øt';
            }
          } catch (error) {
            addressDiv.innerHTML = '<p>L·ªói khi t·∫£i ƒë·ªãa ch·ªâ.</p>';
            addressDiv.style.display = 'block';
            btn.textContent = '·∫®n chi ti·∫øt';
          }
        } else {
          addressDiv.style.display = 'none';
          btn.textContent = 'Xem chi ti·∫øt';
        }
      }

      // Fetch products (th√™m ·∫£nh)
      async function fetchProducts() {
        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();
        const tbody = document.getElementById('productsTable').querySelector('tbody');
        tbody.innerHTML = data.map(p => `
    <tr>
      <td>${p.product_id}</td>
      <td>${p.product_name}</td>
      <td>${formatCurrency(p.price)}</td>
      <td><img src="${p.image_url}" alt="${p.product_name}" style="max-width: 100px; max-height: 100px;"></td>
      <td>${formatCurrency(p.price_promotion)}</td>
      <td>${p.detail}</td>
      <td>${p.collection_id}</td>
      <td>${getProductStatusText(p.status)}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='openForm("products", ${JSON.stringify(p)})'>S·ª≠a</button>
        <button class="btn btn-sm btn-danger" onclick='deleteItem("products", ${p.product_id})'>X√≥a</button>
      </td>
    </tr>
  `).join('');
      }
      // Fetch orders (s·ª≠a ƒë·ªÉ hi·ªÉn th·ªã chi ti·∫øt ƒë∆°n h√†ng)
      async function fetchOrders() {
        const res = await fetch(`${API_BASE}/orders`);
        const data = await res.json();
        const tbody = document.getElementById('ordersTable').querySelector('tbody');
        tbody.innerHTML = '';
        for (let o of data) {
          try {
            const detailsRes = await fetch(`${API_BASE}/orderdetails/${o.order_id}`);
            if (!detailsRes.ok) throw new Error('Failed to fetch order details');
            const details = await detailsRes.json();
            // T√≠nh th·ªëng k√™ cho t·ª´ng order_id
            const totalItems = details.length;
            const totalQuantity = details.reduce((sum, d) => sum + d.quantity, 0);
            const orderRevenue = details.reduce((sum, d) => sum + (d.quantity * d.unit_price), 0);
            const row = document.createElement('tr');
            // ƒê·ªãnh d·∫°ng ng√†y theo UTC+7
            const orderDate = new Date(o.order_date);
            orderDate.setHours(orderDate.getHours() + 7); // ƒêi·ªÅu ch·ªânh m√∫i gi·ªù
            row.innerHTML = `
        <td>${o.order_id}</td>
        <td>${o.user_id}</td>
        <td>${formatCurrency(o.total_amount)}</td>
        <td>${getOrderStatusText(o.status)}</td>
        <td>${new Date(o.order_date).toLocaleString()}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick='openForm("orders", ${JSON.stringify(o)})'>S·ª≠a</button>
          <button class="btn btn-sm btn-danger" onclick='deleteItem("orders", ${o.order_id})'>X√≥a</button>
        </td>
        <td>
          <button class="btn btn-sm btn-info" onclick='toggleDetails(${o.order_id}, this)'>Xem chi ti·∫øt</button>
        </td>
      `;
            tbody.appendChild(row);
            const detailsRow = document.createElement('tr');
            detailsRow.id = `details-${o.order_id}`;
            detailsRow.style.display = 'none';
            detailsRow.innerHTML = `
        <td colspan="7">
          <p>Th·ªëng k√™ order ${o.order_id}: T·ªïng s·∫£n ph·∫©m: ${totalItems}, T·ªïng s·ªë l∆∞·ª£ng: ${totalQuantity}, Doanh thu: ${formatCurrency(orderRevenue)}</p>
          <table class="table table-sm">
            <thead><tr><th>Order ID</th><th>Detail ID</th><th>Product ID</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>PTTT</th><th>Thao t√°c</th></tr></thead>
            <tbody>
              ${details.map(d => `
                <tr>
                  <td>${d.order_id}</td>
                  <td>${d.order_detail_id}</td>
                  <td>${d.product_id}</td>
                  <td>${d.quantity}</td>
                  <td>${formatCurrency(d.unit_price)}</td>
                  <td>${getPayMethodText(d.pay_method)}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick='openForm("orderdetails", ${JSON.stringify(d)})'>S·ª≠a</button>
                    <button class="btn btn-sm btn-danger" onclick='deleteItem("orderdetails", ${d.order_detail_id})'>X√≥a</button>
                  </td>
                </tr>
              `)}
            </tbody>
          </table>
        </td>
      `;
            tbody.appendChild(detailsRow);
          } catch (error) {
            console.error(`L·ªói khi l·∫•y chi ti·∫øt cho order ${o.order_id}:`, error);
            const detailsRow = document.createElement('tr');
            detailsRow.id = `details-${o.order_id}`;
            detailsRow.style.display = 'none';
            detailsRow.innerHTML = `<td colspan="7"><p>L·ªói: Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng.</p></td>`;
            tbody.appendChild(detailsRow);
          }
        }
      }
      // H√†m toggleDetails (ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông)
      function toggleDetails(order_id, btn) {
        const row = document.getElementById(`details-${order_id}`);
        if (row) {
          row.style.display = row.style.display === 'none' ? '' : 'none';
          btn.textContent = row.style.display === 'none' ? 'Xem chi ti·∫øt' : '·∫®n chi ti·∫øt';
        }
      }
      // Fetch collections (th√™m ·∫£nh)
      async function fetchCollections() {
        const res = await fetch(`${API_BASE}/collections`);
        const data = await res.json();
        const tbody = document.getElementById('collectionsTable').querySelector('tbody');
        tbody.innerHTML = data.map(c => `
    <tr>
      <td>${c.collection_id}</td>
      <td>${c.collection_name}</td>
      <td>${c.year_launch}</td>
      <td><img src="${c.image_url}" alt="${c.collection_name}" style="max-width: 100px; max-height: 100px;"></td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='openForm("collections", ${JSON.stringify(c)})'>S·ª≠a</button>
        <button class="btn btn-sm btn-danger" onclick='deleteItem("collections", ${c.collection_id})'>X√≥a</button>
      </td>
    </tr>
  `).join('');
      }
      // H√†m l·∫•y image_url t·ª´ product_id (gi·∫£ ƒë·ªãnh fetch t·ª´ Products table)
      async function getProductImage(productId) {
        const res = await fetch(`${API_BASE}/products/${productId}`);
        const product = await res.json();
        return product && product.image_url ? product.image_url : 'N/A';
      }
      // Th√™m h√†m searchTable v√†o <script>
      function searchTable(type, value) {
        const tableId = `${type}Table`;
        const table = document.getElementById(tableId);
        const trs = table.querySelectorAll('tbody tr');
        const searchTerm = value.toLowerCase();
        trs.forEach(tr => {
          if (tr.id && tr.id.startsWith('details-')) return; // B·ªè qua h√†ng chi ti·∫øt
          const text = tr.textContent.toLowerCase();
          tr.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      }

      // Th√™m h√†m deleteItem v√†o <script>
      async function deleteItem(type, id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?')) return;
        const endpoint = `${API_BASE}/${type}/${id}`;
        await fetch(endpoint, { method: 'DELETE' });
        if (type === 'users') fetchUsers();
        else if (type === 'products') fetchProducts();
        else if (type === 'orders' || type === 'orderdetails') fetchOrders();
        else if (type === 'collections') fetchCollections();
      }

      // Thay th·∫ø h√†m fetchRevenueData v√† th√™m updateRevenueChart
      let revenueChart; // ƒê·ªÉ l∆∞u instance chart v√† destroy khi update
      async function fetchRevenueData(time = 'day', payment = '') {
        // Fetch d·ªØ li·ªáu doanh thu
        let revenueEndpoint = `${API_BASE}/stats/revenue/${time}`;
        if (payment) revenueEndpoint += `?pay_method=${payment}`;
        const revenueRes = await fetch(revenueEndpoint);
        const revenueData = await revenueRes.json();

        // Fetch d·ªØ li·ªáu s·ªë ƒë∆°n h√†ng
        let orderCountEndpoint = `${API_BASE}/stats/ordercount/${time}`;
        if (payment) orderCountEndpoint += `?pay_method=${payment}`;
        const orderCountRes = await fetch(orderCountEndpoint);
        const orderCountData = await orderCountRes.json();

        // Fetch t·ªïng doanh thu
        let totalEndpoint = `${API_BASE}/stats/total`;
        if (payment) totalEndpoint += `?pay_method=${payment}`;
        const totalRes = await fetch(totalEndpoint);
        const totalData = await totalRes.json();
        document.getElementById('totalStats').textContent = `T·ªïng doanh thu: ${formatCurrency(totalData.total_revenue)}`;

        // Chu·∫©n b·ªã d·ªØ li·ªáu cho chart
        const labels = Object.keys(revenueData);
        const revenueValues = Object.values(revenueData);
        const orderCountValues = labels.map(label => orderCountData[label] || 0);

        // Destroy chart c≈© n·∫øu t·ªìn t·∫°i
        if (revenueChart) revenueChart.destroy();
        // C·∫•u h√¨nh chart m·ªõi v·ªõi hai tr·ª•c y
        const ctx = document.getElementById('revenueChart').getContext('2d');
        revenueChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: `Doanh thu theo ${getTimeText(time)} ${payment ? `(PTTT: ${getPayMethodText(payment)})` : ''}`,
                data: revenueValues,
                borderColor: '#FF6384',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.1,
                yAxisID: 'y-revenue'
              },
              {
                label: 'S·ªë ƒë∆°n h√†ng',
                data: orderCountValues,
                borderColor: '#36A2EB',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true,
                tension: 0.1,
                yAxisID: 'y-orders'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || '';
                    let value = context.parsed.y;
                    if (label.includes('Doanh thu')) {
                      return `${label}: ${formatCurrency(value)}`;
                    } else {
                      return `${label}: ${value} ƒë∆°n`;
                    }
                  }
                }
              }
            },
            scales: {
              'y-revenue': {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                title: { display: true, text: 'Doanh thu (VNƒê)' },
                ticks: { callback: value => formatCurrency(value) }
              },
              'y-orders': {
                type: 'linear',
                position: 'right',
                beginAtZero: true,
                title: { display: true, text: 'S·ªë ƒë∆°n h√†ng' },
                grid: { drawOnChartArea: false }, // Kh√¥ng ch·ªìng l·∫•p grid v·ªõi tr·ª•c tr√°i
                ticks: {
                  stepSize: 1, // B∆∞·ªõc nh·∫£y l√† 1 ƒë∆°n v·ªã
                  precision: 0 // Kh√¥ng hi·ªÉn th·ªã s·ªë th·∫≠p ph√¢n
                }
              },
              x: { title: { display: true, text: 'Th·ªùi gian' } }
            }
          }
        });
      }

      // H√†m c·∫≠p nh·∫≠t chart d·ª±a tr√™n select
      function updateRevenueChart() {
        const time = document.getElementById('timeFilter').value;
        const payment = document.getElementById('paymentFilter').value;
        fetchRevenueData(time, payment);
      }

    </script>
    <script>
      async function refreshUsers() {
        try {
          console.log("G·ª≠i y√™u c·∫ßu ƒë·∫øn:", 'http://localhost:3000/api/users');
          const response = await fetch('http://localhost:3000/api/users');
          console.log("Tr·∫°ng th√°i ph·∫£n h·ªìi:", response.status);
          if (!response.ok) {
            throw new Error(`L·ªói HTTP! Tr·∫°ng th√°i: ${response.status} - ${response.statusText}`);
          }
          const users = await response.json();
          console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", users);
          const table = document.getElementById('usersTable');
          if (!table) throw new Error('Kh√¥ng t√¨m th·∫•y b·∫£ng usersTable');
          const tbody = table.querySelector('tbody');
          if (!tbody) throw new Error('Kh√¥ng t√¨m th·∫•y tbody trong b·∫£ng usersTable');
          tbody.innerHTML = ''; // X√≥a n·ªôi dung c≈©
          if (!Array.isArray(users) || users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o ho·∫∑c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.</td></tr>';
            return;
          }
          users.forEach(user => {
            if (!user || typeof user !== 'object') {
              console.warn("D·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá, b·ªè qua:", user);
              return;
            }
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.user_id !== undefined ? user.user_id : 'N/A'}</td>
                <td>${user.username !== undefined ? user.username : 'N/A'}</td>
                <td>${user.email !== undefined ? user.email : 'N/A'}</td>
                <td>${user.role !== undefined ? (user.role === 0 ? 'Customer' : 'Admin') : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick='openForm("users", ${JSON.stringify(user)})' >S·ª≠a</button>
                    <button class="btn btn-sm btn-danger" onclick='deleteItem("users", ${user.user_id !== undefined ? user.user_id : 0})'>X√≥a</button>
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="toggleAddressDetails(${user.user_id !== undefined ? user.user_id : 0}, this)">Xem chi ti·∫øt</button>
                    <div class="address-details" id="address-${user.user_id !== undefined ? user.user_id : 0}"></div>
                </td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error('L·ªói khi l·∫•y danh s√°ch ng∆∞·ªùi d√πng:', error);
          alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ' + error.message);
        }
      }

      // G·ªçi l·∫ßn ƒë·∫ßu khi t·∫£i trang
      window.onload = refreshUsers;

      async function deleteUser(userId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) {
          try {
            const response = await fetch(`http://localhost:3000/api/users/${userId}`, {
              method: 'DELETE'
            });
            if (response.ok) {
              alert('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng');
              refreshUsers(); // L√†m m·ªõi danh s√°ch
            } else {
              alert('X√≥a ng∆∞·ªùi d√πng th·∫•t b·∫°i');
            }
          } catch (error) {
            console.error('L·ªói khi x√≥a ng∆∞·ªùi d√πng:', error);
            alert('L·ªói server');
          }
        }
      }

      // G·ªçi l·∫ßn ƒë·∫ßu khi t·∫£i trang
      window.onload = refreshUsers;
    </script>
    <!-- <script>
      const hasNewMessage = Math.random() < 0.5; // üëâ ƒë·ªïi th√†nh true n·∫øu c√≥ tin nh·∫Øn m·ªõi
      const img = document.getElementById("message-img");
      img.src = hasNewMessage ? "image/mess2.png" : "image/mess1.png";
      const logoutBtn = document.getElementById('logout-btn');
      const logoutMenu = document.getElementById('logout-menu');
      logoutBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        logoutMenu.style.display = logoutMenu.style.display === 'block' ? 'none' : 'block';
      });
      document.addEventListener('click', () => {
        logoutMenu.style.display = 'none';
      });
    </script> -->
</body>

</html>